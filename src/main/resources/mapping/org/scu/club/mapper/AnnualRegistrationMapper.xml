<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//ibatis.apache.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="org.scu.club.mapper.AnnualRegistrationMapper">

  <sql id="allFields">
    annual_reg.id,
    annual_reg.club_id clubId,
    annual_reg.time,
    annual_reg.summary,
    annual_reg.plan,
    annual_reg.`comment`,
    annual_reg.reason,
    annual_reg.audit_status auditStatus,
    annual_reg.create_time createTime,
    annual_reg.update_time updateTime
  </sql>
  
  <select id="getById" parameterType="long" resultType="org.scu.club.entity.AnnualRegistration">
    SELECT
    <include refid="allFields"/>
    FROM
    annual_reg annual_reg
    WHERE
    id = #{id}
  </select>

  <select id="listDetail" parameterType="org.scu.club.vo.QAnnualRegistration" resultType="org.scu.club.vo.VAnnualRegistration">
    SELECT
      <include refid="allFields"/>,
      club.`name` clubName,
      club_type.`name` clubType,
      teacher.`name` teacherName,
      teacher.mobile teacherMobile
    FROM
      annual_reg annual_reg,
      club club,
      teacher teacher
    <if test="userId != null">
      ,club_admin club_admin
    </if>
    WHERE
      club.id = annual_reg.club_id
    AND
      teacher.id = club.teacher_id
    AND
      club.club_type = club_type.id
    <if test="status != null">
      AND audit_status = #{status}
    </if>
    <if test="userId != null">
      AND
      club_admin.user_id = #{userId}
      AND
      annual_reg.club_id = club_admin.club_id
    </if>
    ORDER BY annual_reg.create_time
    DESC
    limit #{startRecord}, #{endRecord}

  </select>

  <select id="count" parameterType="org.scu.club.vo.QAnnualRegistration" resultType="long">
    SELECT
      count(1)
    FROM
    annual_reg annual_reg,
    club club,
    teacher teacher
    <if test="userId != null">
      ,club_admin club_admin
    </if>
    WHERE
    club.id = annual_reg.club_id
    AND
    teacher.id = club.teacher_id
    <if test="status != null">
      AND audit_status = #{status}
    </if>
    <if test="userId != null">
      AND
      club_admin.user_id = #{userId}
      AND
      annual_reg.club_id = club_admin.club_id
    </if>
  </select>

  <insert id="insert"  useGeneratedKeys="true" keyProperty="id">
    INSERT INTO annual_reg
    (
    <trim suffixOverrides=",">
      club_id,
      time,
      summary,
      plan,
      comment,
      audit_status,
      reason,
      create_time,
      update_time,
    </trim>
    )
    VALUES
    (
    <trim suffixOverrides=",">
      #{clubId},
      #{time},
      #{summary},
      #{plan},
      #{comment},
      #{auditStatus},
      #{reason},
      #{createTime},
      #{updateTime},
    </trim>
    )
  </insert>

  <update id="update">
    UPDATE annual_reg
    SET
    <trim suffixOverrides=",">
      club_id = #{clubId},
      time = #{time},
      summary = #{summary},
      plan = #{plan},
      comment = #{comment},
      audit_status = #{auditStatus},
      reason = #{reason},
      create_time = #{createTime},
      update_time = #{updateTime},
    </trim>
    WHERE
    <trim suffixOverrides="and">
      `id` = #{id} and
    </trim>
  </update>
</mapper>